---
layout: post
title: 'Docker에 대해 알아보자(이론편)'
description: 아니!!!! 내가 README.md 보라고 slack에다가 refer. 걸어줬잖아! docker-compose -f docker-compose.dev.yml up --build -d 이게 어렵냐고!! 그리고 개발 프로그램 무식하게 직접 설치할꺼야? elk, oracle DB, tensorflow 기타 등등이 다 5분안에 설치 가능한데?!
image: 'https://i.imgur.com/F2KRB0Q.png'
category: 'docker'
tags:
- docker-compose
- docker
- container
twitter_text: 'Docker에 대해 알아보자(이론편)'
introduction: 아니!!!! 내가 README.md 보라고 slack에다가 refer. 걸어줬잖아! docker-compose -f docker-compose.dev.yml up --build -d 이게 어렵냐고!! 그리고 개발 프로그램 무식하게 직접 설치할꺼야? elk, oracle DB, tensorflow 기타 등등이 다 5분안에 설치 가능한데?!
---

### 이전 포스트입니다.

2017년 4월 2일에 작성된 문서를 재 가공한 포스트입니다. 해당 포스트를 작성했었을 때에는 자위용에 불과해서 자위용포스트는 전부 지워버렸습니다.

> 세상을 재미있게 만들기 위하여!!


### 주의

이 블로그의 내용은 대단히 주관적인 내용이 가득합니다.
그리고 `양질의 글`을 읽었지만 `똥글`이 나오는건 제 미숙함 때문입니다. 
그럼에도 불구하고 피드백 많이 주신다면 자세히 조사하여 반영하도록 하겠습니다.
또한.. 가능한 링크로 올려놓은 자료들은 반드시 열어보시기 바랍니다. 분명 도움이 될 것입니다.
(- -)(_ _)

# Docker를 써야하는 이유

> Docker는 반 가상화보다 경량화된 방식. 게스트 OS를 설치하지 않음. Docker이미지에 서버 운영을 위한 프로그램과 라이브러리를 격리해서 설치할 수 있다. 하드웨어를 가상화하는 계층(Hyper-V)이 없기 때문에 메모리 접근, 파일시스템, 네트워크 속도가 가상머신에 비해 월등히 빠르며, 메인 호스트와 Docker의 컨테이너 사이의 계층과 성능차이는 크게 발생하지 않는다.

> 정말 docker의 성능이 0.925% 까지의 성능 손실이 있는지? 가상화, 반가상화, 컨테이너 정말 몸소 가상화와 반가상화의 차이점을 내가 체험 했었나..?

라고 어려운말을 하는데, 나는 아직 경력도 없는 신입 나부랭이라서, 그런건 잘 모르겠다. 

**그냥 짧고 간단하게 경험에 의한 장점을 말해보자면**

1. 개발 프로그램 설치와 삭제가 매우 쉽다. 5분이면 된다. (elk, reids, mongodb, oracleDB, mysql) 등등. 직접 소스코드 빌드 yum package install 등등의 모든 일련의 작업들이 필요없게 된다.
2. 극 초기의 개발 아키텍쳐를 만들때, 스크립트로 짜 놓기만하면 모두가 같은 환경을 이용할 수 있다.(배포시에는 점진적 scale out)
3. Docker의 컨테이너에 대한 개념은 network에 대한 지식 그리고 cloud platform(GCP, AWS, Azure)에 대한 간접적인 이론을 맛볼 수 있다. *([Immutable Infrastructure 패러다임](http://blog.nacyot.com/articles/2014-04-06-immutable-infrastructure/))이라던지?*
4. 내가 잡은 셋팅의 개발 프로그램 및 운영체제 라던지, 각각의 컨테이너들의 조합을 스크립트로 작성해서 공유할 수 있다.

특히. 1번. 언제까지 `elk, oracleDB, nginx 등등`을 직접 설치하고 암에 걸릴것인가. 그리고 그 직접 설치한 프로그램의 데몬을 언제 직접 네이밍주면서 관리할것인가. 
나도 신입이지만, 나의 소중한 친구들을 바라보자면 소중한 개발머신(개인 랩탑)에 눈뜨고 볼 수 없는 대 환장파티를 벌이고있는데, 뒷통수를 후려치고 싶은 적이 한두번이 아니었다.(농담이다, 사랑한다.)

개발 머신을 소중히 다루기위해서는 각종의 nvm, jenv, rvm 등등의 virtual management 프로그램 뿐만아니라 docker로 container 인스톨 프로그램에 대해서도 알아야할 필요가 있다. 

설치할 시간을 단 5분으로 줄여주는 진기명기한 그대의 이름은! `docker`!

> araboza 시리즈! 도커에 대해 알아보자!


# Docker에 대해 알기전에 알아야할 것들

**1. 가상화란?**
컴퓨터 안에서 컴퓨터를 만들어내기 위한 시도에 의해 탄생한 기술이다. 1960년대에 가상화라는 개념이 처음 등장하였으며,
컴퓨터 성능이 좋아지면서 PC에서도 사용하게 되었다(`Parallels`, `VMware`, `VirtualBox`).
우리가 알고있는 오픈소스 `Open Stack`, 아마존의 `EC2` 또는 그 이외의 `VPC 호스팅 서비스`들이 가상화 서비스의 산물이다.

개인 컴퓨터가 발전하게되면서 서버컴퓨터도 점차 성능이 좋아지게 되었고, 서버컴퓨터의 자원을 효율적으로 관리하기위한 다양한 기법과 기술들이 나오게 되었다.
그러던 도중 '가상화 기술을 이용하여 물리적으로는 하나의 Computer이지만 남는 자원으로 다른 서비스를 돌려도 되지 않을까?'에서 가상화를 이용한 호스팅이 등장하게 되었다.
실제로 서비스를 운영하다보면, 어플리케이션이 기본적으로 소모하는 자원말고 아무것도 사용하고 있지 않을때도 있다.

이러던 시기에 자원에 대한 필요와 분배에 대한 scale out, scale in 을 효율적으로 할 수 있는 기술에 대한 니즈를 가상화가 매꾸게 되었다.
이건 교수님한테 들은이야기인데, 프로젝트를 매번 새로운 버전을 배포할때마다 서버 전체를 ISO로 뜨고, CD로 부팅 이미지로 만들어서 관리했다고 한다.
즉, 가상화로 새롭게 만든 컴퓨터에 서버 전체를 ISO로 뜬 디스크이미지를 설치하여 scale out, scale in을 수행했다고 한다.

지금은 조금 더 발전되어 CD로 들고다닐 필요가 사라졌기에 물리적인 기억보조장치 없이도, 서버 컴퓨터에서는 남는자원을 활용해 가상화로 컴퓨팅 공간을 만들어 낼 수 있다. 
당연한 이야기이지만, 환경에 의존하여 개발 프로그램들을 인스톨하는 과정자체가 사라지고, 이미지를 인스톨만하면 즉시 이용할 수 있다.

**2. 반가상화란?**

하지만 가상화에는 단점들이 존재한다. OS를 아예 만들어내기 때문에 자원낭비를 불러온다. 그렇기 때문에 항상 guest OS를 설치해야만 했었다.
그렇기 때문에 이미지 안에 OS가 포함되기 때문에 이미지 용량이 커지게 되었었다.
심지어 AMD나 Intel CPU에 가상화 기능을 넣었는대도 자원낭비가 생기고 느리기 까지 하다. (쨋든 가상화이기 때문에..)
그래서 호스트와 커널을 공유하는 반 가상화 기술이 등장했다. 이러나 저러나 가상머신은 느리다. 가상머신은 항상 완전한 컴퓨터를 설치해야 하기때문이다.

가상화든 반가상화든, 또는 커널을 공유하던 공유하지 않던, 디스크 이미지를 인스톨하고 만들기 자체가 부담스러운 감이 없지않아 있다. 
심지어 ftp를 이용한 NAS서버를 내부 네트워크에 구성해서 쓰기엔 디스크 이미지가 너무 컷다.
자동화를 한다하더라도, 만든 이미지를 업로드하거나 다운로드 하는 시간이나, 가상머신 구성 및 디스크 설치하는 시간이나 10분 이상도 기다려주지 않는 사용자들에 대응하기에는 부담이 되는시간이다.
(그렇기에 `immutable infrastructure`가 대두된 이유지만... 우선 컨테이너 설명부터...) 이런 단점으로 인하여 컨테이너 기술이 나오게 되었다.

**3. 컨테이너란?**

컨테이너 기술은 `리눅스의 컨테이너(LXC)`(cgroups, namespaces) 를 활용한 기술이다.
Docker의 핵심기술은리눅스의 컨테이너 기술을 이용한 컨테이너는 가상화나 반 가상화보다 훨씬 빠르게 새로운 가상머신을 만들어낼 수 있다.
정확히말하면 가상머신은 아니지만, 쨋든 독립적인 컴퓨팅 공간(가상공간)을 만들어 낸다.
하지만 만들어진 가상 공간안에 실행파일은 호스트(공간이 독립적인것이지 실행하는 주체는 docker를 실행시킨 사용자 자신이다.)에서 직접 실행한다.

- [성능이 궁금한 분들을 위한 Docker 가상화의 원리와 장단점](http://www.opennaru.com/openshift/docker/what-is-the-difference-between-docker-lxd-and-lxc/)

![가상화와 컨테이너 기술의 차이](https://i.imgur.com/RedNSRT.png)


**4.그럼 컨테이너하고 이미지는 무슨 차이?**

- 이미지
    1. 서비스 운영에 필요한 서버 프로그램, 소스코드, 컴파일된 실행파일을 묶은 형태 
    2. 저장소에 올리고 받는것은 이미지 : push and pull

- 컨테이너
    1. 컨테이너는 이미지를 이미 실행한 형태
    2. 이미지로 여러개의 컨테이너를 만들 수 있다.

즉, 운영체제 측면으로 본다면 이미지는 실행파일, 컨테이너는 프로세스

# Docker가 나오기 전 대부분의 서비스 운영환경

- 지금까지는 물리적인 서버를 직접 운영하는 방식이었음.
- 호스팅 또는 IDC코로케이션 서비스 이용
- 이전까지는 서버 구입과 운영까지 많은 비용이 소모되고 시간이 오래걸렸다.
- 가상화가 발전하면서 클라우드 환경으로 변화
- 가상 서버를 임대하여 이용한 만큼 돈을 지불하는 방식이었음
- 단순한 클릭 몇번으로 서버가(가상화, 반가상화된) 생성되었다.
- 이제는 자동으로 서버를 생성하고 삭제까지도 할 수 있게 되었다.
- 현재는 서버 대수가 많아지게되면서 관리하기가 힘들어지게 됨
- 그렇다면 많아진 서버 대수를 어떻게 셋팅하고 배포를 하게 될 것인가?
- 이 많아진 서버 대수를 관리하기위한 서버관리 측면의 패러다임이 나오게 됨.
- Immutable Infrastructure 라는 패러다임이 나옴

# Docker

Docker는 LXC에서 사용하는 리눅스 커널 컨테이너 기술을 이용해 만든 컨테이터 관리 유틸리티이며,
Build, Ship, Run Docker는 서비스 운영환경을 묶어서 손 쉽게 배포하고 실행하는 경량컨테이너 기술이다.

- Docker는 2013년 docker.inc에서 출시한 **오픈소스 컨테이너** 프로젝트
- AWS, Google Cloud Platform, Azure 에서 공식 지원중

# Docker의 로고

![docker](https://i.imgur.com/5DJjNOW.png)

- 컨테이너를 싣고 다니는 고래
- Build, Ship, Run
- Docker는 부두 노동자를 의미함, 컨테이너를 다루는 Docker의 기능과 비슷함
- 고래는 서버에서 여러 개의 컨테이너(이미지)를 실행하고 이미지 저장과 배포(운반)을 의미

# Docker의 특징

1. 컨테이너 이미지 생성 및 공유 (아무런 docker프로젝트에 들어가서 프로젝트안에 있는 Dockerfile를 아무 지식없이 열어보면 해당 이미지를 만들어내기 위한 인스톨 및 작업에 대한 명령어들이 모아져있는것을 알 수 있다.
)
2. 도커에서는 github처럼 [docker hub](https://hub.docker.com/)란것이 존재한다.
3. docker-compose라는 cli 프로그램을 번들로써 제공함. docker-compose.yml 파일을 이용하면 컨테이너들의 구성(아키텍쳐)을 공유할 수 있다.
4. 기반은 컨테이너지만 단순한 저장공간 컨테이너(볼륨)를 만들어 저장공간을 container끼리 연결할 수 있으며, 실행한 호스트의 컴퓨터에도 접근할 수 있다.
(기반은 container의 심화적 활용을 이용한것이지만 많이 쓰인다.)
5. Docker는 게스트 OS를 설치하지 않는다.
6. 이미지에 서버 운영을 위한 프로그램과 라이브러리만 격리해서 설치 가능
7. 이미지 용량이 크게 줄어든다.
8. 호스트와 OS자원을 공유(시스템 콜(System call) 등....)
9. **Docker는 하드웨어 가상화 계층이 존재하지 않음**(메모리접근, 파일접근 등등 관련한 기능에서 가상화보다 빠른 성능을 보여줌)
10. 이미지 생성과 배포에 특화되어있다. 그것과 연관으로 이미지 버전관리 제공한다. 중앙저장소에 이미지([docker hub](https://hub.docker.com/))를 올리고 받을 수 있다
11. 다양한 API를 사용하여 원하는 만큼 자동화가 가능함, 개발과 서버운용에 매우 유용함.

# Docker의 컨테이너 버전관리(이미지 처리 방식 = 컨테이너 생성 방식)

사실 Docker의 버전관리? 그냥 Docker의 script모음집을 말하는거 아닌가? 그게 그렇게 커다란 특징이 있나?
싶겠지만, 이렇게 생각한사람은 'Docker의 컨테이너는 Dockerfile 이다'라는 오해를 가지고 있을것이다.
엄밀히 말하면 **Docker에 대해 알기전에 알아야할 것들-4**에서 자세히 이미지와 컨테이너의 차이점에 대해서 설명해놓았지만 Dockerfile은 이미지이며, 아직 작업의 처리가 되지 않은 상태의 스크립트 모음집이다.
Docker의 컨테이너는 Dockerfile을 실행한 결과물을 말하며, 여기에서 말하는 컨테이너 버전관리는 scripts모음집에서 오래걸리는 패키지인스톨들(yum, brew, apt-get, wget, curl 등)들에 대한 변화감지에 따른
독립적인 공간의 환경구축 버전관리를 이야기한다. 정말 말 그대로 `컨테이너(가상공간)`의 버전관리를 말한다.

- 유니온 파일 시스템 형식 (aufs, btrfs, devicemapper)
- Docker 베이스 이미지에서 바뀐부분만 이미지로 생성
- 컨테이너로 실행할 때는 베이스 이미지와 바뀐부분을 합쳐서 실행
- 즉, Docker Hub 및 개인 저장소에서 이미지를 공유할 때, 바뀐부분만 주고 받음
- 각 이미지는 매 버전마다 의존관계를 가지게(형성하게) 됨

# Immutable Infrastructure 

![다스케테 이무타브루쨩!](https://i.imgur.com/OBqfX2d.png)

#### 등장배경

어떤가? 가상머신(독립적인 공간, 컨테이너)만들기가 매우 쉽고 간단하지 않은가?
개발 아키텍쳐를 간단하게 구성하고 싶을때에 docker를 써야겠다는 생각이 마구마구 들지 않는가?
docker만 설치되어있다면, 어떤 프로그램 인스톨이라든지 신경이 전혀 안쓰지 않는가!?

이제 설명할 것은 Immutable Infrastructure이다. 이것은 가상화 기술이 있을때부터 계속 나왔던 용어이며, 어쩌면 페러다임으로도 불리는 용어이다.
컨테이너 생성과 공유 그리고 설치가 매우 간단해지게되면서, 소스코드 자체를 하나의 컨테이너 실행단위에 맏겨두어도 무리가 없을거라 생각하기 시작했다.
그도 그럴게 적은 리소스와 시간으로 새로운 운영체제를 만들어낼 수 있고 찍어내어 scale out에도 매우 용이하기 때문이다.

어쨋든 contaienr가 그렇게 좋고 편하다는것은 알 겠다. 그렇다면 정말 Immutable Structure란 무엇일까?

#### Immutable Infrastructure 란?

Immutable Infrastructure란 호스트 OS와 서비스 운영 환경(서버 프로그램, 소스코드, 컴파일된 바이너리)들을 분리하여 한번 설정한 서버환경은 변경하지 않는다.
이는 Immutable개념을 따른것이다. 서비스 운영환경을 이미지로 생성한 뒤 서버에 배포하여 실행하고, 서비스가 업데이트 되면 운영환경 자체를 변경하지 않고, 이미지를 새로 생성하여 배포한다.
클라우드 플랫폼에서 서버를 쓰고 버리는것과 같이 Immutable Infrastructure도 서비스 운영환경 이미지를 한번 쓰고 버리는 패러다임이다.

이런 관점에 있어서 AWS Elastic Beanstalk가 Docker만큼이나 Immutable Infrastructure의 니즈에 충분히 충족하는것 같지 않은가!

#### Immutable Infrastructure의 장점

- 편리한 관리
  - 서비스 환경 이미지만 관리하면 된다.
  - 중앙관리를 통한 배포와 관리
  - 이미지 생성에 버전관리 시스템 활용 

- 확상정
  - 이미지 하나로 서버를 계속해서 찍어낼 수 있음
  - 클라우트 플랫폼의 자동확장(Auto Scaling)기능와 연동하여 손쉽게 서비스를 확장할 수 있다.

- 테스트
  - 개발자 PC또는 테스트 서버에서 이미지를 실행하면 서비스 운영환경과 동일한 환경이 구축됨
  - 테스트가 간편해진다.

- 가벼움
  - 운영체제와 서비스환경을 분리하여 가볍고 어디서나 실행가능한 환경을 제공할 수 있다. 

즉, Docker는 Immutable Infrastructure를 구현한 프로젝트로 볼 수 있다. (아주 주관적인 의견입니다.)
 
## 참고 링크
 - [1. 아주 유명한 pyrasis님의 Docker 입문 슬라이드, 거의 필독 슬라이드라 봐도 무방하다](https://www.slideshare.net/pyrasis/docker-fordummies-44424016)
 - [2. boot2docker](https://docs.docker.com/machine/install-machine/#installing-machine-directly) // 마지막부분 내용 좋음
 - [3. 성능이 궁금한 분들을 위한 Docker 가상화의 원리와 장단점](http://www.opennaru.com/openshift/docker/what-is-the-difference-between-docker-lxd-and-lxc/)

